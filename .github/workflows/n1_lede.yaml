name: N1_OpenWrt_Build
run-name: Build N1 OpenWrt - ${{ inputs.model || 'N1_lede_lua'}}

on:
  workflow_dispatch:
    inputs:
      model:
        required: true
        description: N1 Configuration
        type: choice
        default: N1_lede_lua
        options:
          - N1_lede_lua
          - N1_lede_js

      runs-on:
        description: Runner OS
        type: choice
        default: ubuntu-22.04
        options:
          - ubuntu-20.04
          - ubuntu-22.04

  schedule:
    - cron: '05 10 * * 4'  # 每周四10:05 UTC (北京时间18:05)

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_DIR: n1_lede/config
  SCRIPT_DIR: n1_lede/sh
  FEEDS_CONF: ${{ github.workspace }}/n1_lede/feeds.conf.default
  CONFIG_FILE: ${{ github.workspace }}/n1_lede/config/${{ inputs.model || 'N1_lede_lua'}}.config
  DIY_SH: ${{ github.workspace }}/n1_lede/sh/${{ inputs.model || 'N1_lede_lua'}}_diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  FIRMWARE_NAME: N1_OpenWrt
  PRODUCT_NAME: Phicomm_N1

jobs:
  build:
    runs-on: ${{ inputs.runs-on || 'ubuntu-22.04'}}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        path: 'my-openwrt'

    - name: Setup environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get -qq update
        sudo apt-get -qq install $(cat my-openwrt/n1_lede/depends-ubuntu-2204)
        sudo apt-get -qq clean
        
    - name: Create swap
      run: |
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Prepare OpenWrt source
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        
        # Apply custom configurations
        cp -f ${{ env.FEEDS_CONF }} .
        cp -f ${{ env.CONFIG_FILE }} .config
        chmod +x ${{ env.DIY_SH }}
        ./${{ env.DIY_SH }}
        
        # Record version info
        echo "COMMIT_INFO=$(git log -1 --pretty='%h - %s [%an]')" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

    - name: Build OpenWrt
      uses: ophub/flippy-openwrt-actions@main
      env:
        OPENWRT_ARMVIRT: https://github.com/ophub/amlogic-s9xxx-openwrt/releases/download/openwrt_s9xxx/amlogic-s9xxx-openwrt.tar.gz
        PACKAGE_SOC: s905d
        KERNEL_VERSION_NAME: 5.15.150
        KERNEL_AUTO_LATEST: false
        UPLOAD_RELEASE: true
        GH_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Create release info
      run: |
        echo "**N1 OpenWrt 固件**" > release.md
        echo "- 编译日期: $(date +%Y-%m-%d)" >> release.md
        echo "- 源码分支: $REPO_BRANCH" >> release.md
        echo "- 最新提交: ${{ env.COMMIT_INFO }}" >> release.md
        echo "- 默认IP: 192.168.1.1" >> release.md
        echo "- 用户名: root" >> release.md
        echo "- 密码: password" >> release.md
        echo "\n**包含插件:**" >> release.md
        grep "luci-app" .config | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g' >> release.md

    - name: Upload firmware
      uses: softprops/action-gh-release@v2
      if: ${{ env.UPLOAD_RELEASE == 'true' }}
      with:
        tag_name: ${{ env.BUILD_DATE }}_${{ env.FIRMWARE_NAME }}
        name: ${{ env.PRODUCT_NAME }}_${{ env.BUILD_DATE }}
        body_path: release.md
        files: openwrt/output/*.img.gz

    - name: Clean old releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}